-- Membuat tabel yang berisi informasi pendapatan/revenue perusahaan total untuk masing-masing tahun 
-- (Hint: Revenue adalah harga barang dan juga biaya kirim. Pastikan juga melakukan filtering terhadap order status yang tepat untuk menghitung pendapatan)
CREATE TABLE revenue_by_year AS
	SELECT  
		DATE_PART('year', o.order_purchase_timestamp) AS year_transaction,
		SUM(revenue_per_order) AS revenue
	FROM (
		SELECT 
			order_id, 
			SUM(price+freight_value) AS revenue_per_order
		FROM order_items_dataset
		GROUP BY 1
		) subq
	JOIN orders_dataset o ON subq.order_id = o.order_id
	WHERE o.order_status = 'delivered'
	GROUP BY 1
	ORDER BY 1;

-- Membuat tabel yang berisi informasi jumlah cancel order total untuk masing-masing tahun 
--(Hint: Perhatikan filtering terhadap order status yang tepat untuk menghitung jumlah cancel order)

CREATE TABLE canceled_order_by_year AS 
	SELECT 
		DATE_PART('year', order_purchase_timestamp) AS year_transaction,
		COUNT(order_id) AS total_canceled_order
	FROM orders_dataset
	WHERE order_status = 'canceled'
	GROUP BY 1
	ORDER BY 1;

--Membuat tabel yang berisi nama kategori produk yang memberikan pendapatan total tertinggi untuk masing-masing tahun 
--(Hint: Perhatikan penggunaan window function dan juga filtering yang dilakukan)
CREATE TABLE top_category_revenue_by_year AS
	SELECT 
		year_transaction,
		product_category_name,
		revenue
	FROM (
		SELECT 
			year_transaction,
			product_category_name,
			SUM(price+freight_value) AS revenue,
			RANK () OVER(
				PARTITION BY year_transaction
				ORDER BY SUM(price+freight_value) DESC
			) AS rank_revenue
		FROM order_items_dataset AS oid
		JOIN (
			SELECT 
				order_id,
				DATE_PART('year', order_purchase_timestamp) AS year_transaction
			FROM orders_dataset
			WHERE order_status = 'delivered'
			) AS orders
		ON oid.order_id = orders.order_id
		JOIN products_dataset AS p
		ON oid.product_id = p.product_id
		GROUP BY 1,2
	) AS revenue_category
	WHERE rank_revenue = 1;


-- Membuat tabel yang berisi nama kategori produk yang memiliki jumlah cancel order terbanyak untuk masing-masing tahun 
-- (Hint: Perhatikan penggunaan window function dan juga filtering yang dilakukan)
CREATE TABLE top_category_canceled_order_by_year AS
	SELECT 
		year_transaction,
		product_category_name,
		canceled_order
	FROM (
		SELECT 
			year_transaction,
			product_category_name,
			COUNT(oid.order_id) AS canceled_order,
			RANK () OVER(
				PARTITION BY year_transaction
				ORDER BY COUNT(oid.order_id) DESC
			) AS rank_cancel
		FROM order_items_dataset AS oid
		JOIN (
			SELECT 
				order_id,
				DATE_PART('year', order_purchase_timestamp) AS year_transaction
			FROM orders_dataset
			WHERE order_status ='canceled'
			) AS orders
		ON oid.order_id = orders.order_id
		JOIN products_dataset AS p
		ON oid.product_id = p.product_id
		GROUP BY 1,2
	) AS canceled
	WHERE rank_cancel = 1;


--JOIN ALL CREATE TABLE

SELECT
	rby.year_transaction AS year_transaction,
	rby.revenue AS total_revenue,
	tcrby.product_category_name AS highest_revenue_category,
	tcrby.revenue AS highest_revenue,
	coby.total_canceled_order AS total_canceled_order,
	tccoby.product_category_name AS highest_canceled_order_category,
	tccoby.canceled_order AS highest_canceled_order
FROM revenue_by_year AS rby
JOIN canceled_order_by_year AS coby ON rby.year_transaction = coby.year_transaction
JOIN top_category_revenue_by_year AS tcrby ON coby.year_transaction = tcrby.year_transaction
JOIN top_category_canceled_order_by_year AS tccoby ON tcrby.year_transaction = tccoby.year_transaction;